<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.zephyr.mpbsgather.mapper.NoteCollectionRelationMapper">

    <!-- 根据 noteId 查询对应的 gatherId -->
    <select id="queryGatherIdByNoteId" parameterType="String" resultType="String">
        SELECT collection_id
        FROM note_collection_relation
        WHERE note_id = #{noteId}
            LIMIT 1
    </select>

    <!-- 根据 gatherId 统计对应 noteId 的数量 -->
    <select id="countNoteIdByGatherId" parameterType="String" resultType="int">
        SELECT COUNT(note_id)
        FROM note_collection_relation
        WHERE collection_id = #{gatherId}
    </select>

    <!-- 根据 noteId 查询索引 index -->
    <select id="queryIndexByNoteId" parameterType="String" resultType="int">
        SELECT order_index
        FROM note_collection_relation
        WHERE note_id = #{noteId}
            LIMIT 1
    </select>

    <!-- 根据 gatherId 查询对应的所有 noteId 列表 -->
    <select id="queryNoteIdByGatherId" parameterType="String" resultType="String">
        SELECT note_id
        FROM note_collection_relation
        WHERE collection_id = #{gatherId}
        ORDER BY order_index ASC
    </select>

    <update id="batchUpdateNoteOrder" parameterType="map">
        UPDATE note_collection_relation
        SET order_index = CASE note_id
        <foreach collection="orderMap" index="noteId" item="idx">
            WHEN #{noteId} THEN #{idx}
        </foreach>
        ELSE order_index
        END
        WHERE collection_id = #{gatherId}
        AND note_id IN
        <foreach collection="orderMap.keySet()" item="noteId" open="(" separator="," close=")">
            #{noteId}
        </foreach>
    </update>

    <select id="getMaxOrderNumBygatherId" resultType="java.lang.Integer">
        SELECT COALESCE(MAX(order_Index), 0)
        FROM note_collection_relation
        WHERE collection_id = #{gatherId}
    </select>

    <insert id="addNoteToGather">
        INSERT INTO note_collection_relation (collection_id, note_id, order_index)
        VALUES (#{dto.gatherId}, #{dto.noteId}, #{maxOrderNumByParentId})
    </insert>

</mapper>